<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <title>Vera Cruz 15K — V3 (82% cap)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Fonte e Chart.js -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121821;
      --muted: #8aa0b4;
      --text: #e7eef6;
      --brand: #ff7a00;
      --brand-2: #31d0aa;
      --danger: #ff4d4f;
      --ok: #2ecc71;
      --warn: #f4c150;
      --ring: 0 0 0 2px rgba(255, 122, 0, .25);
      --card: #0f141c;
      --card2: #0d1118;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: linear-gradient(180deg, #0a0e13 0, #0b1017 100%);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial
    }

    a {
      color: inherit;
      text-decoration: none
    }

    .container {
      max-width: 1120px;
      margin: 0 auto;
      padding: 24px
    }

    header {
      position: sticky;
      top: 0;
      backdrop-filter: saturate(1.2) blur(8px);
      background: rgba(11, 15, 20, .7);
      border-bottom: 1px solid #1c2430;
      z-index: 3
    }

    .nav {
      display: flex;
      gap: 14px;
      align-items: center;
      justify-content: space-between;
      padding: 12px 24px
    }

    .brand {
      display: flex;
      gap: 10px;
      align-items: center;
      font-weight: 700
    }

    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(49, 208, 170, .12);
      color: #b5f5e1;
      font-size: 12px;
      border: 1px solid rgba(49, 208, 170, .35)
    }

    .tabs {
      display: flex;
      gap: 10px
    }

    .tab {
      padding: 8px 12px;
      border-radius: 10px;
      background: #0f141c;
      border: 1px solid #1a2230;
      color: #cfe3f6;
      font-weight: 600
    }

    .tab.active {
      background: linear-gradient(180deg, #182231, #111826);
      border-color: #263246;
      box-shadow: var(--ring)
    }

    .grid {
      display: grid;
      gap: 16px
    }

    .g-2 {
      grid-template-columns: 1.2fr .8fr
    }

    .g-3 {
      grid-template-columns: repeat(3, 1fr)
    }

    .g-4 {
      grid-template-columns: repeat(4, 1fr)
    }

    .card {
      background: linear-gradient(180deg, #0f141c, #0d1118);
      border: 1px solid #1a2332;
      border-radius: 16px;
      padding: 16px
    }

    .card h3 {
      margin: 0 0 8px
    }

    .sub {
      color: var(--muted);
      font-size: 12px
    }

    .kpi {
      display: flex;
      gap: 18px;
      align-items: center;
      flex-wrap: wrap
    }

    .kpi .pill {
      background: #0b1119;
      border: 1px solid #1c2431;
      border-radius: 12px;
      padding: 10px 12px
    }

    .pill strong {
      font-size: 18px
    }

    .progress {
      height: 10px;
      border-radius: 999px;
      background: #121a25;
      overflow: hidden;
      border: 1px solid #223042
    }

    .progress>div {
      height: 100%;
      background: linear-gradient(90deg, var(--brand), #ff9b3a);
      width: 0%
    }

    .btn {
      background: linear-gradient(180deg, #ff7a00, #ff6a00);
      border: none;
      color: #101316;
      font-weight: 800;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer
    }

    .btn.secondary {
      background: #121a24;
      color: #cfe3f6;
      border: 1px solid #273245
    }

    .btn.small {
      padding: 8px 10px;
      font-size: 12px;
      border-radius: 10px
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap
    }

    .stat {
      display: flex;
      flex-direction: column;
      gap: 4px
    }

    .tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #243044;
      background: #0d131c;
      color: #b7c8da
    }

    .day-card {
      display: flex;
      flex-direction: column;
      gap: 10px
    }

    .day-head {
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    .check {
      display: flex;
      align-items: center;
      gap: 8px
    }

    input[type="number"] {
      background: #0b1119;
      border: 1px solid #202a3a;
      color: #e7eef6;
      border-radius: 10px;
      padding: 8px 10px;
      width: 100%
    }

    input[type="checkbox"] {
      accent-color: #ff7a00;
      width: 18px;
      height: 18px
    }

    select,
    textarea {
      background: #0b1119;
      border: 1px solid #202a3a;
      color: #e7eef6;
      border-radius: 10px;
      padding: 10px
    }

    textarea {
      min-height: 96px;
      width: 100%
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    th,
    td {
      border-bottom: 1px solid #1b2330;
      padding: 10px 8px;
      text-align: left
    }

    th {
      color: #9fb4c9;
      font-weight: 600
    }

    .lvl {
      font-weight: 800
    }

    .toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: #0e151f;
      border: 1px solid #203047;
      padding: 12px 14px;
      border-radius: 12px;
      display: none
    }

    .muted {
      color: #9fb4c9
    }

    .warn {
      color: #ffd590
    }

    .ok {
      color: #8ff1c9
    }

    .danger {
      color: #ffb3b3
    }

    footer {
      opacity: .6;
      font-size: 12px;
      padding: 24px
    }

    .link {
      color: #8ecbff;
      text-decoration: underline
    }

    .xpbar {
      height: 14px;
      border-radius: 12px;
      background: #101724;
      border: 1px solid #203045;
      overflow: hidden
    }

    .xpbar>div {
      height: 100%;
      background: linear-gradient(90deg, #31d0aa, #8dffa1)
    }

    .mini {
      font-size: 12px;
      color: #a9bdd1
    }

    @media (max-width:980px) {

      .g-2,
      .g-3,
      .g-4 {
        grid-template-columns: 1fr
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="nav">
      <div class="brand">
        <span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:var(--brand)"></span>
        <span>Vera Cruz 15K</span>
        <span class="badge">V3 • 82% cap • +20% ramp</span>
      </div>
      <div class="tabs">
        <a class="tab active" data-tab="dash">Dashboard</a>
        <a class="tab" data-tab="plan">Plano</a>
        <a class="tab" data-tab="log">Registrar</a>
        <a class="tab" data-tab="gloss">Glossário</a>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- DASHBOARD -->
    <section id="tab-dash">
      <div class="grid g-2">
        <div class="card">
          <h3>Semana Atual <span id="wk-label" class="tag"></span></h3>
          <div class="sub" id="phase-label"></div>
          <div class="kpi" style="margin:12px 0 6px">
            <div class="pill">
              <div class="stat"><span class="mini">Volume alvo</span><strong id="target-km">–</strong></div>
            </div>
            <div class="pill">
              <div class="stat"><span class="mini">Longão</span><strong id="long-km">–</strong></div>
            </div>
            <div class="pill">
              <div class="stat"><span class="mini">Progresso</span><strong id="progress-km">0 km</strong></div>
            </div>
            <div class="pill">
              <div class="stat"><span class="mini">Nível</span><span class="lvl" id="level-label">1</span><span
                  class="mini" id="xp-label">0 / 100 XP</span></div>
            </div>
          </div>
          <div class="progress" style="margin-top:6px">
            <div id="progress-bar"></div>
          </div>
          <div id="ramp-guard" class="sub warn" style="margin-top:8px;display:none">Ajuste automático aplicado para
            respeitar ramp-up ≤ 20% e longão ≤ 12,3 km.</div>
        </div>

        <div class="card">
          <h3>Evolutivo Semanal</h3>
          <canvas id="evoChart" height="120"></canvas>
          <div class="mini muted" style="margin-top:8px">Comparação de alvo (médio da faixa) vs. realizado.</div>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3>Treinos da Semana</h3>
          <div class="row">
            <button class="btn small" id="prev-week">◀</button>
            <select id="week-select"></select>
            <button class="btn small" id="next-week">▶</button>
            <button class="btn" id="save-week">Salvar Semana</button>
          </div>
        </div>
        <div id="days-grid" class="grid g-4" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- PLANO -->
    <section id="tab-plan" style="display:none">
      <div class="card">
        <h3>Plano de 12 Semanas</h3>
        <div class="sub" id="range-note"></div>
        <div class="muted mini" style="margin:6px 0 12px">Regras seguras: longão ≤ 12,3 km; ramp-up ≤ 20% no alvo máx.
          semana a semana.</div>
        <div style="overflow:auto">
          <table id="plan-table">
            <thead>
              <tr>
                <th>Sem</th>
                <th>Fase</th>
                <th>Volume (km)</th>
                <th>Longão</th>
                <th>Qualidade 1</th>
                <th>Qualidade 2</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- REGISTRAR -->
    <section id="tab-log" style="display:none">
      <div class="card">
        <h3>Registrar Semana</h3>
        <div class="row" style="margin-bottom:10px">
          <label>Semana:
            <select id="log-week"></select>
          </label>
        </div>
        <div class="grid g-3">
          <div>
            <div class="mini muted">Aderência (%)</div><input type="number" id="f-adherence" min="0" max="100"
              placeholder="0-100">
          </div>
          <div>
            <div class="mini muted">Dor máxima (0–10)</div><input type="number" id="f-pain" min="0" max="10">
          </div>
          <div>
            <div class="mini muted">Fadiga (0–10)</div><input type="number" id="f-fatigue" min="0" max="10">
          </div>
          <div>
            <div class="mini muted">Rigidez muscular (0–10)</div><input type="number" id="f-stiff" min="0" max="10">
          </div>
          <div>
            <div class="mini muted">Variação FC repouso (bpm)</div><input type="number" id="f-rhr">
          </div>
          <div>
            <div class="mini muted">Horas de sono (média)</div><input type="number" id="f-sleep" step="0.1" value="7.5">
          </div>
        </div>
        <div class="row" style="margin:10px 0">
          <label class="check"><input type="checkbox" id="f-heat"> <span>Calor/umidade altos na maioria dos
              treinos</span></label>
          <label class="check"><input type="checkbox" id="f-ill"> <span>Ocorrência de doença ou lesão</span></label>
        </div>
        <textarea id="f-notes" placeholder="Como você se sentiu na semana? Alguma dificuldade ou conquista?"></textarea>
        <div class="row" style="margin-top:12px;justify-content:flex-end">
          <button class="btn" id="save-log">Salvar e ajustar próximas semanas</button>
        </div>
        <div class="mini muted" style="margin-top:8px">Ajuste automático: reduz 10–20% na próxima semana se sinais de
          risco (aderência baixa, dor/fadiga ≥ 7, ↑FCrepouso ≥ 8, calor/lesão). Nunca aumenta mais de 20% semana a
          semana.</div>
      </div>
    </section>

    <!-- GLOSSÁRIO -->
    <section id="tab-gloss" style="display:none">
      <div class="card">
        <h3>Glossário</h3>
        <ul>
          <li><b>RPE</b>: Escala de esforço percebido (0–10).</li>
          <li><b>RP15K</b>: Ritmo objetivo para 15 km.</li>
          <li><b>Strides</b>: Acelerações curtas (10–20 s) focadas em técnica/neural.</li>
          <li><b>Deload</b>: Semana de descarga para consolidar adaptações.</li>
          <li><b>Ramp-up</b>: Variação de volume entre semanas. Limite deste plano: ≤ 20%.</li>
        </ul>
      </div>
    </section>
  </main>

  <div class="toast" id="toast"></div>

  <!-- Modal Detalhes -->
  <div id="modal"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); align-items:center; justify-content:center; z-index:50;">
    <div style="background:#0e151f; border:1px solid #203047; border-radius:12px; width:min(560px,92vw); padding:16px">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px">
        <h3 id="modal-title" style="margin:0">Detalhes do treino</h3>
        <button id="modal-close" class="btn small">Fechar</button>
      </div>
      <div id="modal-body" class="mini" style="margin-top:10px; line-height:1.6"></div>
    </div>
  </div>

  <footer class="container">Protótipo local. Para produção, esconda a chave via proxy. • Feito em HTML/CSS/JS + Chart.js
    • JSONBin persistente.</footer>

  <script>
    /** =========================
     *  CONFIG / PERSISTÊNCIA
     *  ========================= */
    const CONFIG = {
      BIN_ID: "68dd7453ae596e708f02c066",
      MASTER_KEY: "$2a$10$pCaKVQGHO8mzMVJ4EszoSOY29nEuOgnOLr3yt9KP.Qby1mqu2ZWga", // ❗ Não use em prod no front.
      JSONBIN: "https://api.jsonbin.io/v3/b",
    };
    const hdr = {
      "X-Master-Key": CONFIG.MASTER_KEY,
      "X-Bin-Meta": "false",
      "Content-Type": "application/json"
    };

    const initialPlan = { plan: { weeks: [] } }

    // --- helpers de data/semana ---
    const wkDay = (d) => { const map = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"]; return map[d.getDay()] };
    function isoDate(d = new Date()) { return d.toISOString().slice(0, 10) }
    function weekDiff(start, date) {
      const ms = new Date(date) - new Date(start);
      const w = Math.floor(ms / (1000 * 60 * 60 * 24 * 7)) + 1;
      return Math.max(1, Math.min(w, 12));
    }

    // ---- Estado em memória ---
    let state = null;      // documento inteiro do bin
    let currentWeek = 1;   // semana selecionada
    let evoChart = null;   // Chart.js instance
    let saveTimer = null;  // debounce

    // ===== debounce de salvamento =====
    function debouncedSave() {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(async () => {
        try { await saveBin(state); toast("Atualizado ✅", "ok"); }
        catch (e) { console.error(e); toast("Falha ao salvar", "danger"); }
      }, 600);
    }

    // ================== JSONBIN IO ==================
    async function loadBin() {
      const url = `${CONFIG.JSONBIN}/${CONFIG.BIN_ID}/latest`;
      const res = await fetch(url, { headers: hdr });
      if (!res.ok) { throw new Error("Falha ao ler JSONBin"); }
      const data = await res.json();
      return data;
    }
    async function saveBin(newDoc) {
      const url = `${CONFIG.JSONBIN}/${CONFIG.BIN_ID}`;
      const res = await fetch(url, { method: "PUT", headers: hdr, body: JSON.stringify(newDoc) });
      if (!res.ok) { throw new Error("Falha ao salvar JSONBin"); }
      return await res.json();
    }

    // ================== PLANO / REGRAS ==================
    function ensureStartDate(plan) {
      if (plan.start_date === "{{auto_hoje}}") { plan.start_date = isoDate(new Date()); }
    }

    function enforceSafety(plan) {
      // Longão cap e ramp-up ≤ 20% (em target_km_max)
      const weeks = plan.weeks;
      for (let i = 0; i < weeks.length; i++) {
        weeks[i].long_run_km = Math.min(weeks[i].long_run_km, 12.3);
        if (i > 0) {
          const prev = weeks[i - 1].target_km_max;
          const cap = Math.floor(prev * 1.20);
          if (weeks[i].target_km_max > cap) {
            weeks[i].target_km_max = cap;
            weeks[i].__ramp_guard = true;
          }
          weeks[i].target_km_min = Math.min(weeks[i].target_km_min, weeks[i].target_km_max);
        }
      }
    }

    function weekMidTarget(wk) { return Math.round((wk.target_km_min + wk.target_km_max) / 2); }

    // ===== detalhes de treino / ritmos =====
    function fmtPace(sec) { const m = Math.floor(sec / 60), s = String(Math.round(sec % 60)).padStart(2, "0"); return `${m}:${s}/km`; }
    function paceHint(plan, intensity) {
      const pr = plan.pace_ranges || {};
      if (intensity === "tempo") return `${fmtPace(pr.tempo_min)} – ${fmtPace(pr.tempo_max)}`;
      if (intensity === "reps" || intensity === "10K" || intensity === "10K/15K") return `${fmtPace(pr.reps_min)} – ${fmtPace(pr.reps_max)}`;
      return `${fmtPace(pr.easy_min_s_per_km)} – ${fmtPace(pr.easy_max_s_per_km)}`;
    }
    function detailsForSession(plan, wk, s) {
      const wu = plan.defaults.warmup_min, cd = plan.defaults.cooldown_min;
      const q1 = wk.quality1, q2 = wk.quality2;
      const tag = (s.tag || "").toLowerCase();
      if (tag === "quality" && s.name === q1?.name) {
        return `<b>${q1.name}</b><br>${q1.structure}<br><span class="muted">Ritmo alvo:</span> ${paceHint(plan, q1.target_intensity)}<br><span class="muted">Aquec.</span> ${wu} min • <span class="muted">Desaquec.</span> ${cd} min`;
      }
      if (tag === "quality") {
        return `<b>${q2?.name || s.name}</b><br>${q2?.structure || "Qualidade 2"}<br><span class="muted">Ritmo alvo:</span> ${paceHint(plan, q2?.target_intensity || "tempo")}<br><span class="muted">Aquec.</span> ${wu} min • <span class="muted">Desaquec.</span> ${cd} min`;
      }
      if (tag === "long") {
        return `<b>Longo progressivo</b><br>Confortável, progressivo no final.<br><span class="muted">Ritmo alvo:</span> ${paceHint(plan, "easy")}<br><span class="muted">Aquec.</span> ${wu} min • <span class="muted">Desaquec.</span> ${cd} min`;
      }
      if (tag === "easy") {
        const extras = s.name.includes("Strides") ? " + 6–8×15 s strides" :
          s.name.includes("Técnica") ? " + 8–10 min de drills" : "";
        return `<b>${s.name}</b><br><span class="muted">Ritmo alvo:</span> ${paceHint(plan, "easy")}${extras}<br><span class="muted">Aquec.</span> ${wu} min • <span class="muted">Desaquec.</span> ${cd} min`;
      }
      if (tag === "strength") {
        return `<b>${s.name}</b><br>Força geral (A/B), 30–40 min (pernas/core). Evitar fadiga antes de qualidade/longão.`;
      }
      return `<b>${s.name}</b>`;
    }
    function openModal(title, html) {
      const m = document.getElementById("modal");
      document.getElementById("modal-title").textContent = title;
      document.getElementById("modal-body").innerHTML = html;
      m.style.display = "flex";
    }
    document.getElementById("modal-close").onclick = () => { document.getElementById("modal").style.display = "none"; };
    document.getElementById("modal").addEventListener("click", (e) => { if (e.target.id === "modal") e.currentTarget.style.display = "none"; });

    // Distribuição simples de km pelos dias (gamificada, estável e previsível)
    function sessionsForWeek(plan, wIndex) {
      const wk = plan.weeks[wIndex];
      const target = weekMidTarget(wk);
      const long = wk.long_run_km;
      const q1 = Math.round(target * 0.18);
      const q2 = Math.round(target * 0.12);
      const easy1 = Math.round(target * 0.17);
      const easy2 = Math.round(target * 0.15);
      const easy3 = Math.max(0, target - (long + q1 + q2 + easy1 + easy2)); // fecha total
      const structure = plan.defaults.week_structure;

      const map = {
        "strength_A": { name: "Força A", km: 0, tag: "Strength" },
        "easy_strides": { name: "Corrida leve + Strides", km: easy1, tag: "Easy" },
        "quality_1": { name: wk.quality1?.name || "Qualidade 1", km: q1, tag: "Quality" },
        "off_or_cross": { name: "Descanso / Cross", km: 0, tag: "Recovery" },
        "strength_B_or_quality_2": { name: wk.quality2?.name || "Força B / Q2", km: q2, tag: "Quality" },
        "easy_technique": { name: "Corrida leve + Técnica", km: easy2, tag: "Easy" },
        "long_progressive": { name: "Longo progressivo", km: long, tag: "Long" }
      };

      if ((wk.notes || "").toLowerCase().includes("remover q2")) {
        map["strength_B_or_quality_2"].km = 0;
        map["strength_B_or_quality_2"].tag = "Recovery";
        map["strength_B_or_quality_2"].name = "Força B / Off (Q2 opcional)";
      }

      map["easy_technique"].km += Math.round(easy3 * 0.6);
      map["easy_strides"].km += Math.round(easy3 * 0.4);

      const sessions = structure.map(s => ({
        day: s.day,
        type: s.type,
        planned_km: map[s.type].km,
        name: map[s.type].name,
        tag: map[s.type].tag,
        done: false,
        km: 0
      }));

      if (!wk.sessions) wk.sessions = sessions;
      else {
        wk.sessions = wk.sessions.map((old, i) => {
          const fresh = sessions[i];
          return { ...old, planned_km: fresh.planned_km, name: fresh.name, tag: fresh.tag, type: fresh.type };
        });
      }
      return wk.sessions;
    }

    function realizedKm(wk) {
      const s = (wk.sessions || []).reduce((acc, cur) => acc + (Number(cur.km) || 0), 0);
      wk.realized_km = Math.round(s * 10) / 10;
      return wk.realized_km;
    }

    function xpFromKm(km) { return Math.floor(km * 10); } // 1 km = 10 XP
    function levelFromXP(xp) { return Math.floor(xp / 100) + 1; }

    // Ajuste automático conservador para próxima semana
    function autoAdjust(plan, wIndex, register) {
      const wk = plan.weeks[wIndex];
      const next = plan.weeks[wIndex + 1];
      if (!next) return false;

      const total = realizedKm(wk);
      const prevMax = wk.target_km_max;

      const risk =
        (Number(register.adherence || 0) < 60) ||
        (Number(register.pain || 0) >= 7) ||
        (Number(register.fatigue || 0) >= 7) ||
        (Number(register.rhr || 0) >= 8) ||
        !!register.heat ||
        !!register.ill;

      let proposalMax = Math.min(next.target_km_max, Math.floor(prevMax * 1.2));
      let proposalMin = Math.min(next.target_km_min, proposalMax);

      if (risk) {
        proposalMax = Math.floor(prevMax * 0.9);
        proposalMin = Math.floor(proposalMax * 0.9);
        next.notes = (next.notes ? next.notes + " " : "") + "Ajuste seguro: reduzir ~10–20% e considerar remover Q2.";
        next.quality2 && (next.quality2.name = (next.quality2.name || "Q2") + " (opcional)");
        next.long_run_km = Math.min(12.3, Math.floor(wk.long_run_km * 0.9));
        next.__auto_adjusted = true;
      } else {
        const goodProgress = total >= Math.floor(prevMax * 0.9);
        if (goodProgress) {
          proposalMax = Math.min(proposalMax, Math.floor(prevMax * 1.10));
          proposalMin = Math.max(proposalMin, Math.floor(proposalMax * 0.9));
          next.long_run_km = Math.min(12.3, Math.max(next.long_run_km, Math.floor(wk.long_run_km * 1.05)));
          next.__auto_adjusted = true;
        }
      }
      next.target_km_max = proposalMax;
      next.target_km_min = proposalMin;
      enforceSafety(plan);
      sessionsForWeek(plan, wIndex + 1);
      return true;
    }

    // ================== UI RENDER ==================
    const $ = (q) => document.querySelector(q);
    function toast(msg, cls = "") { const t = $("#toast"); t.textContent = msg; t.className = "toast " + cls; t.style.display = "block"; setTimeout(() => t.style.display = "none", 2400); }

    function renderPlanTable(plan) {
      const tb = $("#plan-table tbody"); tb.innerHTML = "";
      plan.weeks.forEach(w => {
        const tr = document.createElement("tr");
        const vol = `${w.target_km_min}–${w.target_km_max}`;
        tr.innerHTML = `
          <td>S${w.number}</td>
          <td>${w.phase}</td>
          <td>${vol}</td>
          <td>${w.long_run_km.toFixed(1)} km</td>
          <td>${w.quality1?.name || "-"}</td>
          <td>${w.quality2?.name || "-"}</td>`;
        tb.appendChild(tr);
      });
      $("#range-note").textContent = `${plan.name} • Início: ${plan.start_date} • Prova: ${plan.race_date}`;
    }

    function buildDaysGrid(plan, wIndex) {
      const grid = $("#days-grid"); grid.innerHTML = "";
      const wk = plan.weeks[wIndex];
      sessionsForWeek(plan, wIndex);
      wk.sessions.forEach((s, idx) => {
        const el = document.createElement("div");
        el.className = "card day-card";
        const dow = s.day;
        el.innerHTML = `
      <div class="day-head">
        <div class="row" style="gap:8px;align-items:center">
          <div class="tag">${dow}</div>
          <div class="tag">${s.tag}</div>
        </div>
        <label class="check">
          <input type="checkbox" ${s.done ? "checked" : ""} data-idx="${idx}" class="ch-done"> <span>Concluído</span>
        </label>
      </div>
      <div><div class="mini muted">Treino</div><div style="font-weight:600">${s.name}</div></div>
      <div><div class="mini muted">Km planejado</div><div>${s.planned_km} km</div></div>
      <div>
        <div class="mini muted">Km realizados</div>
        <input type="number" min="0" step="0.1" value="${Number(s.km || 0)}" data-idx="${idx}" class="in-km">
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn secondary small btn-details" data-idx="${idx}">Detalhes</button>
      </div>`;
        grid.appendChild(el);
      });

      // listeners
      grid.querySelectorAll(".ch-done").forEach(ch => {
        ch.addEventListener("change", (e) => {
          const i = Number(e.target.dataset.idx);
          // auto-preenche km com planejado ao concluir; zera se desmarcar (quando igual ao planejado)
          if (e.target.checked && (Number(wk.sessions[i].km || 0) === 0)) {
            wk.sessions[i].km = Number(wk.sessions[i].planned_km || 0);
            grid.querySelector(`input.in-km[data-idx="${i}"]`).value = wk.sessions[i].km;
          } else if (!e.target.checked && Number(wk.sessions[i].km || 0) === Number(wk.sessions[i].planned_km || 0)) {
            wk.sessions[i].km = 0;
            grid.querySelector(`input.in-km[data-idx="${i}"]`).value = 0;
          }
          wk.sessions[i].done = e.target.checked;
          updateProgressUI(plan, wIndex);
          renderEvoChart(state.plan);
          debouncedSave();
        });
      });

      grid.querySelectorAll(".in-km").forEach(inp => {
        inp.addEventListener("input", (e) => {
          const i = Number(e.target.dataset.idx);
          wk.sessions[i].km = Number(e.target.value || 0);
          // marca como concluído se km > 0; desmarca se zerar
          wk.sessions[i].done = wk.sessions[i].km > 0 ? true : false;
          const ch = grid.querySelector(`.ch-done[data-idx="${i}"]`);
          if (ch) ch.checked = wk.sessions[i].done;
          updateProgressUI(plan, wIndex);
          renderEvoChart(state.plan);
          debouncedSave();
        });
      });

      grid.querySelectorAll(".btn-details").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const i = Number(e.target.dataset.idx);
          const s = wk.sessions[i];
          const html = detailsForSession(plan, wk, s);
          openModal(`${s.day} — ${s.name}`, html);
        });
      });

      updateProgressUI(plan, wIndex);
    }

    function updateProgressUI(plan, wIndex) {
      const wk = plan.weeks[wIndex];
      const total = realizedKm(wk);
      const targetMid = weekMidTarget(wk);
      $("#progress-km").textContent = `${total} km`;
      const pct = Math.max(0, Math.min(100, Math.round((total / targetMid) * 100)));
      $("#progress-bar").style.width = pct + "%";

      const xp = xpFromKm(total);
      $("#xp-label").textContent = `${xp % 100} / 100 XP`;
      $("#level-label").textContent = levelFromXP(xp);
    }

    function renderWeekHeader(plan, wIndex) {
      const wk = plan.weeks[wIndex];
      $("#wk-label").textContent = `S${wk.number}`;
      $("#phase-label").textContent = wk.phase;
      $("#target-km").textContent = `${wk.target_km_min}–${wk.target_km_max} km`;
      $("#long-km").textContent = `${wk.long_run_km.toFixed(1)} km`;
      const guard = wk.__ramp_guard || wk.__auto_adjusted;
      $("#ramp-guard").style.display = guard ? "block" : "none";
    }

    function renderWeekSelectors(plan) {
      const sel = $("#week-select"); const sel2 = $("#log-week");
      sel.innerHTML = ""; sel2.innerHTML = "";
      plan.weeks.forEach(w => {
        const o = document.createElement("option"); o.value = w.number; o.textContent = `Semana ${w.number}`; sel.appendChild(o);
        const o2 = o.cloneNode(true); sel2.appendChild(o2);
      });
      sel.value = currentWeek; sel2.value = currentWeek;
    }

    function renderEvoChart(plan) {
      const labels = plan.weeks.map(w => `S${w.number}`);
      const target = plan.weeks.map(w => weekMidTarget(w));
      const realized = plan.weeks.map(w => Number(w.realized_km || 0));
      if (evoChart) { evoChart.destroy(); }
      const ctx = document.getElementById('evoChart');
      evoChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Alvo', data: target, tension: .35 },
            { label: 'Realizado', data: realized, tension: .35 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: '#cfe3f6' } } },
          scales: { x: { ticks: { color: '#9fb4c9' } }, y: { ticks: { color: '#9fb4c9' } } }
        }
      });
    }

    // ================== NAV ==================
    document.querySelectorAll(".tab").forEach(t => {
      t.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
        t.classList.add("active");
        const sel = t.dataset.tab;
        ["dash", "plan", "log", "gloss"].forEach(id => {
          document.getElementById(`tab-${id}`)?.style.setProperty("display", id === sel ? "block" : "none");
        });
        if (sel === "plan") renderPlanTable(state.plan);
      });
    });

    $("#prev-week").onclick = () => { currentWeek = Math.max(1, currentWeek - 1); refreshWeekUI(); };
    $("#next-week").onclick = () => { currentWeek = Math.min(12, currentWeek + 1); refreshWeekUI(); };
    $("#week-select").onchange = (e) => { currentWeek = Number(e.target.value); refreshWeekUI(); };
    $("#log-week").onchange = (e) => { /* nada */ };

    // salvar semana (sessions km/done)
    $("#save-week").onclick = async () => {
      try {
        await saveBin(state);
        toast("Semana salva no JSONBin ✅", "ok");
        renderEvoChart(state.plan);
      } catch (e) { toast("Erro ao salvar no JSONBin", "danger"); console.error(e); }
    };

    // salvar registro + ajustes
    $("#save-log").onclick = async () => {
      try {
        const wIndex = Number($("#log-week").value) - 1;
        const reg = {
          adherence: Number($("#f-adherence").value || 0),
          pain: Number($("#f-pain").value || 0),
          fatigue: Number($("#f-fatigue").value || 0),
          stiff: Number($("#f-stiff").value || 0),
          rhr: Number($("#f-rhr").value || 0),
          sleep: Number($("#f-sleep").value || 0),
          heat: $("#f-heat").checked,
          ill: $("#f-ill").checked,
          notes: $("#f-notes").value || ""
        };
        state.plan.weeks[wIndex].register = reg;
        autoAdjust(state.plan, wIndex, reg);
        await saveBin(state);
        toast("Registro salvo e plano ajustado ✅", "ok");
        refreshAll();
      } catch (e) { toast("Erro ao registrar/ajustar", "danger"); console.error(e); }
    };

    // ================== BOOT ==================
    async function boot() {
      try {
        let doc = await loadBin();
        if (!doc?.plan) { doc = initialPlan; }
        ensureStartDate(doc.plan);
        enforceSafety(doc.plan);
        currentWeek = weekDiff(doc.plan.start_date, isoDate(new Date()));
        state = doc;
        for (let i = 0; i < state.plan.weeks.length; i++) sessionsForWeek(state.plan, i);
        await saveBin(state); // normaliza
        refreshAll();
      } catch (e) {
        console.error(e);
        state = initialPlan; ensureStartDate(state.plan); enforceSafety(state.plan);
        for (let i = 0; i < state.plan.weeks.length; i++) sessionsForWeek(state.plan, i);
        refreshAll();
        toast("Falha ao ler JSONBin; usando dados locais (não persistem).", "warn");
      }
    }

    function refreshWeekUI() {
      const idx = currentWeek - 1;
      renderWeekSelectors(state.plan);
      renderWeekHeader(state.plan, idx);
      buildDaysGrid(state.plan, idx);
    }
    function refreshAll() {
      renderWeekSelectors(state.plan);
      refreshWeekUI();
      renderPlanTable(state.plan);
      renderEvoChart(state.plan);
    }

    boot();
  </script>
</body>

</html>